# Open the door

`open_the_door` 是作者在闲暇时与舍友共同开发的一个项目，旨在为宿舍门提供更便捷的开门方式——这样就不用再为忘带钥匙而烦恼了。我们先后讨论并测试了多种方案，比如通过网络远程开门、输入密码开门等等，但出于能耗、安全等方面的考虑，我们最终选择了通过刷校园卡开门的方式；不过，你也可以很容易地将这个项目扩展到其它开门方式上。

本项目由 C++ 编写，基于 Arduino 开发平台和 ESP32 开发板。如果你使用相似的硬件，可以参照**快速开始**快速部署；如果你想修改代码以适应其他硬件，请参照**开发**。**用法**介绍了使用方式和具体功能。

本项目使用了[这些库](https://github.com/illustager/MyArduino)的一部分。



## 特点

- Arduino C++ 编写，使用 ESP32 开发板

- 通过刷校园卡开门

- 带登录密码的管理系统支持随时添加、查看、删除用户

- 使用睡眠模式，节省能耗

- 开门同时播放音频表示欢迎

- 易于移植（详见**开发**）



## 快速开始

1. 准备 ESP32-WROOM-32 或其它兼容的 MCU。准备舵机（用于开门）、读卡器（我使用的是 RFID-RC522）、4X4键盘、OLED屏幕、音频功放模块和喇叭。如果不想使用这些硬件来达成你的目标，请参照**开发**。
2. 将硬件安装在合适的地方，并与 ESP32 连接。注意键盘和屏幕是用于管理用户的，所以请安装在门内侧。
3. 将 ESP32 的某个触摸引脚引出到门外，用于触摸唤醒休眠中的 ESP32。
4. 根据硬件的连接情况，修改工程中每个 .cpp 文件开头的 config 部分。你可能需要修改某个硬件连接的引脚，或者舵机开关门需要的时间和角度，或者进入管理系统的密码。
5. 构建、上传程序并测试。



## 用法

正常情况下电源指示灯常亮，而板载蓝灯灭，表示 ESP32 睡眠。

需要开门时，触摸引出的触摸引脚，ESP32 板载蓝灯微亮，表示其启动。

刷校园卡，如果检测通过，ESP32 板载蓝灯亮，舵机拉动门锁打开，同时播放音频对来者表示欢迎。

ESP32 唤醒时，按键‘D’可以进入管理系统。输入密码后按‘D’确定，‘C’退出，‘#’/‘\*’清除输入；进入编辑界面后，按‘#’删除，‘A’/‘B’移动光标，直接刷卡以添加用户，‘D’保存并退出。用户数据重启后依旧保存，不必每次重新录入。



## 开发

本项目原本专为作者使用的硬件开发，但后期作者尽量将硬件相关的代码移到独立的文件中，以提高它的可移植性。

1. **door.h**/**door.cpp**

   如果你想为你的门设计不同的开门方式，请根据你所使用的硬件重写 `door::open()` 与 `door::close()`

2. **lowpower.h**/**lowpower.cpp**

   如果你并没有使用 ESP32，请修改此文件中的相关函数，以开启你选择的 MCU 的低功耗模式。如果你的 MCU 不支持低功耗模式，请将这些函数留空

3. **play.h**/**play.cpp**

   `play::task(void*)` 函数将会在开门的同时以第二线程的方式执行。如果你希望开门的时候能点亮彩灯或发生除默认的播放音频外的其它行为，可以修改其中的内容。如果你的 MCU 不支持双线程，也可以移除此函数，或者在 `door::open()` 中调用它

   **sound_data.h**

   里面记录了用于播放的音频数据。如果你想播放其它音频，请将你的音频转为 wav 格式并通过某款十六进制编辑器得到它的数据，并替换此文件中的数组；注意 **play.cpp** 也需要同步修改

4. **statusinfo.h**/**statusinfo.cpp**

   控制 LED 以显示系统当前的工作状态。你可以重写其中的函数来适应你的需要。

5. **manage.h**/**manage.cpp**

   用户管理系统。

   如果你想要使用不同型号的读卡器、键盘或OLED屏幕，请相应地修改此文件与之相关的内容——这是一个比较麻烦的工作，因为我懒得将它与硬件解耦。

   如果你使用不同型号的 MCU，只需要修改 `nvsSave` 和 `nvsLoad` 两个函数。这两个函数的作用是将用户数据写入可靠的存储器中（如 flash）